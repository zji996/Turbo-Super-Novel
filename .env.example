# Turbo-Super-Novel (.env)
# ═══════════════════════════════════════════════════════════════════════════════
#
# 快速开始：
#   cp .env.example .env    # 复制配置
#   docker compose -f infra/docker-compose.dev.yml up -d   # 启动依赖服务
#   bash scripts/tsn_up.sh  # 启动应用
#
# ═══════════════════════════════════════════════════════════════════════════════


# ┌─────────────────────────────────────────────────────────────────────────────┐
# │                           🎯 GPU 模式 (重要)                                 │
# └─────────────────────────────────────────────────────────────────────────────┘
# 
# 选择一个最适合你的模式：
#
#   fast     - 🚀 速度优先 (推荐 24GB+ 显存)
#              模型常驻显存，推理最快，支持并发处理
#              → TD_RESIDENT_GPU=1, CELERY_CONCURRENCY=2, CELERY_POOL=threads
#
#   balanced - ⚖️ 平衡模式 (推荐 16-24GB 显存) [默认]
#              显存更稳：按需加载模型，单任务处理
#              → TD_RESIDENT_GPU=0, CELERY_CONCURRENCY=1, CELERY_POOL=prefork
#
#   lowvram  - 💾 显存优先 (12GB 及以下显存)
#              按需加载模型，节省显存，速度较慢
#              → TD_RESIDENT_GPU=0, CELERY_CONCURRENCY=1, CELERY_POOL=prefork
#
GPU_MODE=balanced


# ┌─────────────────────────────────────────────────────────────────────────────┐
# │                           🔌 必填 - 服务连接                                 │
# └─────────────────────────────────────────────────────────────────────────────┘

# Redis (任务队列)
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0

# S3 / MinIO (文件存储)
S3_ENDPOINT=http://localhost:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET_NAME=turbo-super-novel
S3_REGION=us-east-1

# PostgreSQL (任务状态持久化)
DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/tsn


# ┌─────────────────────────────────────────────────────────────────────────────┐
# │                    📁 可选 - 目录路径 (留空使用默认值)                        │
# └─────────────────────────────────────────────────────────────────────────────┘

# 模型目录 (默认: <项目根目录>/models)
MODELS_DIR=

# 数据目录 (默认: <项目根目录>/data)  
DATA_DIR=

# 日志目录 (默认: <项目根目录>/logs)
LOG_DIR=

# Worker 安装的可选依赖组（uv sync --group ...）
# 默认: cuda,sagesla（推理加速；若本机 CUDA 工具链不匹配导致安装失败，会自动降级为仅 cuda）
# 如需强制只装 cuda：TSN_WORKER_UV_GROUPS=cuda
# 如需禁用额外组：TSN_WORKER_UV_GROUPS=
TSN_WORKER_UV_GROUPS=cuda,sagesla


# ┌─────────────────────────────────────────────────────────────────────────────┐
# │                    🌐 可选 - API 服务配置                                    │
# └─────────────────────────────────────────────────────────────────────────────┘

API_HOST=0.0.0.0
API_PORT=8000
# 开发模式热重载 (生产环境设为 0)
API_RELOAD=1


# ══════════════════════════════════════════════════════════════════════════════
#                              高级配置 (通常不需要修改)
# ══════════════════════════════════════════════════════════════════════════════

# Docker Compose 使用的 PostgreSQL 配置
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=tsn

# Text Encoder 格式: bf16 或 df11 (df11 更节省显存)
TD_TEXT_ENCODER_FORMAT=df11

# Text Encoder 设备: cuda 或 cpu (显存紧张时可设为 cpu)
TD_UMT5_DEVICE=cuda

# HuggingFace / Transformers 离线模式（禁止任何网络访问）
# 开启后若本地缺少 tokenizer 文件会直接报错；推荐配合 `TD_UMT5_TOKENIZER_DIR` 使用。
TD_HF_OFFLINE=0

# UMT5 tokenizer 本地目录（推荐）
# 默认会优先使用：
# - <MODELS_DIR>/2v/text-encoder/umt5-xxl-tokenizer（若存在）
# - 否则 <MODELS_DIR>/2v/text-encoder-df11/umt5-xxl-tokenizer（若存在）
# 也可手动指定：TD_UMT5_TOKENIZER_DIR=/abs/path/to/umt5-xxl-tokenizer
TD_UMT5_TOKENIZER_DIR=

# 或者直接指定 tokenizer id（HF repo id 或本地目录路径）
# TD_UMT5_TOKENIZER=google/umt5-xxl

# I2V 视频输出参数
# 默认 fps=16；若你希望更精细的时长控制，可以提高 fps（会增大生成负担）
TD_VIDEO_FPS=16
# API 允许的最大视频时长（秒），用于防止误传超大 duration_seconds
TD_MAX_VIDEO_SECONDS=10

# PyTorch 内存分配优化
PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
TOKENIZERS_PARALLELISM=false

# ─────────────────────────────────────────────────────────────────────────────
# 手动覆盖 (仅当你知道自己在做什么时使用)
# ─────────────────────────────────────────────────────────────────────────────
# 以下选项会覆盖 GPU_MODE 的自动配置：
#
# CELERY_CONCURRENCY=    # 并发数 (留空使用 GPU_MODE 推荐值)
# TD_RESIDENT_GPU=       # 模型常驻显存 0/1 (留空使用 GPU_MODE 推荐值)
# CELERY_POOL=           # Worker 池类型 threads/prefork (留空自动选择)
# TD_CUDA_CLEANUP=       # 任务后清理显存 0/1 (默认 1)
#
# CELERY_LOG_LEVEL=info
# CELERY_PREFETCH_MULTIPLIER=1
# CELERY_MAX_TASKS_PER_CHILD=
# CELERY_MAX_MEMORY_PER_CHILD=
# PID_DIR=
# HF_HOME=
#
# CUDA 工具链 (仅编译 turbo_diffusion_ops 时需要)
# CUDA_HOME=$HOME/.local/cuda-12.8
# CUDACXX=$CUDA_HOME/bin/nvcc
# PATH=$CUDA_HOME/bin:$PATH
# LD_LIBRARY_PATH=$CUDA_HOME/lib64:${LD_LIBRARY_PATH:-}
# CUTLASS_DIR=$DATA_DIR/cutlass-v4.3.0
#
# 一键构建 turbo_diffusion_ops（量化 Wan2.2 权重需要）：
# TSN_BUILD_TD_OPS=1
